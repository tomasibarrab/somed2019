const packageFile = require(`${process.cwd()}/package.json`);
const { getRawDeployVersion, getRawPackageVersion, validateManifestFile, validatePackageFile } = require('gca-mono/lib/package-utils');

/*
* This script is always executed in the context of a microapp.
* It loads the current app's manifest/package.json files,
* uses gca-mono's package parsing utility to extract version numbers,
* and applies formatting to version numbers to make them safe for being used in S3 filenames.
* (replaces semver periods with hyphens)
*/

function formatVersionHyphenated(dotSeparatedVersion = '') {
  return dotSeparatedVersion.replace(/\./g, '-'); // 1.2.3 -> 1-2-3
}

function formatVersionSemver(hypenSeparatedVersion = '') {
  return hypenSeparatedVersion.replace(/\-/g, '.'); // 1-2-3 -> 1.2.3
}


module.exports = {
  formatVersionHyphenated,
  formatVersionSemver,
  getManifestFile: () => {
    const manifestFile = require(`${process.cwd()}/src/manifest.json`);
    return validateManifestFile(manifestFile)
  },
  getPackageFile: () => validatePackageFile(packageFile),
  getPackageVersion: () => formatVersionHyphenated(getRawPackageVersion(packageFile)),
  getDeployVersion: (profileName) => formatVersionHyphenated(getRawDeployVersion(packageFile, profileName)),
}