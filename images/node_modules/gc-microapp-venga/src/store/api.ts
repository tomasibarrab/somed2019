import { BaseAgreementDTO } from '@buffet/user-agreement';
import 'rxjs/add/observable/fromPromise';
import { Observable } from 'rxjs/Observable';
import { ajaxGetJSON, ajaxPost } from 'rxjs/observable/dom/AjaxObservable';


import { getContextUrn } from '../helpers/appHelpers';
import {
  LeadGenFormData,
  PricingResponse,
  PrimaryProductsResponse,
  StatusResponse,
  UserAgreementPayload,
} from './types';


const defaultHeaders = {
  'Content-Type': 'application/json',
};

// =============================== API factories =============================================

export const sendLeadGen = (payload: LeadGenFormData) =>
  ajaxPost(
    `/gateway/proxies/partnerServices/api/v1/pos/${payload.RID__c}/lead`,
    payload,
    defaultHeaders,
  );

/**
 * @param rid
 * @deprecated
 */
export const fetchIsSignedUp = (rid: number): Observable<PrimaryProductsResponse> =>
  ajaxGetJSON(
    `/gateway/proxies/rideService/api/v1/productline/restaurants/${rid}/primary_products`,
    defaultHeaders,
  );

export const fetchIsActive = (rid: number): Observable<StatusResponse> =>
  ajaxGetJSON(
    `/gateway/proxies/partnerServices/api/v1/restaurants/${rid}`, // TODO: use path for Venga active status endpoint
    defaultHeaders,
  );

export const getUserAgreement = ({ rid, agreementType }: UserAgreementPayload): Observable<BaseAgreementDTO> =>
  ajaxGetJSON(
    `/gateway/proxies/userAgreementService/v1/user-agreement/agreements/${agreementType}/${getContextUrn(rid)}`,
    defaultHeaders,
  );

export const getProductPricing = (rid: number): Observable<PricingResponse> =>
  ajaxGetJSON(
    `/gateway/proxies/productPricingService/api/v1/products/addon-bundle?rid=${rid}`,
    defaultHeaders,
  );
