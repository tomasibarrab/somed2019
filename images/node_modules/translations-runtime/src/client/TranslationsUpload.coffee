module.exports = (SmartlingClient, Promise, _) ->

  class TranslationsUpload

    constructor: (@bundles) ->

    @upload: (bundles) ->
      (new TranslationsUpload(bundles)).upload()

    upload: ->
      Promise.map _.values(@bundles), @uploadBundleKeys

    uploadBundleKeys: (bundle) =>
      @getClientInstance(bundle)
        .upload(@getUploadOptions(bundle))
        .catch(@handleUploadResponse)

    getClientInstance: (bundle) ->
      @client ?= new SmartlingClient(bundle?.smartling?.userIdentifier, bundle?.smartling?.userSecret, bundle?.smartling?.projectId)
      @client

    getUploadOptions: (bundle) ->
      {
        fileUri: bundle?.smartling?.fileUri
        content: JSON.stringify(bundle?.keys)
      }

    handleUploadResponse: (body) ->
      Promise.reject(new Error("Could not upload to smartling"))
