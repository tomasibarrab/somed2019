import React from 'react';
import Chance from 'chance';
import { select } from '@storybook/addon-knobs';
import { SlideController } from '../SlideController';
import { addMinutes, isBefore, format, startOfHour, isEqual } from 'date-fns';

import { icicleStory } from './icicleSlide.story';
import { barStory } from './barSlide.story';

const getTimeLabel = (date) => {
  if (isEqual(startOfHour(date), date)) {
    return format(date, 'ha');
  }

  const halfHour = addMinutes(startOfHour(date), 30);

  if (isEqual(halfHour, date)) {
    return format(date, 'h:mma');
  }

  return '';
};

const createFifteenMinuteIntervals = (from, until) => {
  let time = new Date(from);
  const timeUntil = new Date(until);
  const intervals = [];

  while (isBefore(time, timeUntil)) {
    intervals.push(time);
    time = addMinutes(time, 15);
  }

  return intervals.map((date) => ({
    id: format(new Date(date), 'DD-MM-YYYY--HH:mm'),
    label: getTimeLabel(new Date(date)),
  }));
}

const getColumns = (shiftLength) => {
  if (shiftLength === 'long') {
    const startDate = new Date('Sep 01 2018 17:00:00');
    const endDate = new Date('Sep 02 2018 03:00:00');
    return createFifteenMinuteIntervals(startDate, endDate);
  }

  const startDate = new Date('Sep 01 2018 09:00:00');
  const endDate = new Date('Sep 01 2018 12:00:00');
  return createFifteenMinuteIntervals(startDate, endDate);
}

export const SliderStory = () => {
  const visualisationSelection = select('Datavis', {
    'Bars': 'bars',
    'Area': 'area',
    'Icicle': 'icicle',
  }, 'icicle');

  const columns = select('Shift length', {
    'Long': getColumns('long'),
    'Short': getColumns('short'),
  });

  const slideDistance = select('Slide distance', {
    '1': 100,
    '1/2': 50,
    '1/3': 33,
    '1/4': 25,
    '1/5': 20,
  }, 33);

  let vis = barStory;
  if (visualisationSelection === 'icicle') {
    vis = icicleStory;
  }

  return (
    <article className="markdown-body">
      <h1>SlideController</h1>
      {columns && (
        <SlideController
          columnWidth={40}
          columnPadding={4}
          slideDistance={slideDistance}
        >
          {vis(columns)}
        </SlideController>
      )}
    </article>
  );
};