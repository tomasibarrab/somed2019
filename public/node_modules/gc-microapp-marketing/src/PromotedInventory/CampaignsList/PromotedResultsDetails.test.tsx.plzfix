import { mount } from 'enzyme';
import moment from 'moment';
import React from 'react';
import { IntlProvider } from 'react-intl';
import { Provider } from 'react-redux';
import { create } from 'react-test-renderer';
import configureMockStore from 'redux-mock-store';
import { CampaignState, CampaignType, CampaignTypes } from '../../store/campaigns/campaigns.types';
import { keys } from '../../translations/bundles/marketing.json';
import PromotedResultsDetails from './PromotedResultsDetails';

// force UTC so tests run the same way on all environments
Intl.DateTimeFormat = jest.fn(() => ({
  format: (date: any) => date.toUTCString(),
}));

jest.mock('moment', () => {
  const momentTz = require.requireActual('moment-timezone');
  momentTz.tz.setDefault('UTC');
  return momentTz;
});

jest.mock('./DetailLines/CoverPrice', () => () => 'CoverPrice Component Mock');

describe('<PromotedResultsDetails />', () => {
  const yesterday = '2017-11-26T12:00:00Z';
  const today = '2017-11-27T12:00:00Z';
  const tomorrow = '2017-11-28T12:00:00Z';
  const dayAfterTomorrow = '2017-11-29T12:00:00Z';

  const suppressionDates = {
    custom: [
      {
        endDate: tomorrow,
        label: 'test label',
        startDate: yesterday,
      },
    ],
    default: ['thanksgiving_day_us'],
  };

  const state = {
    campaigns: {
      error: undefined,
      failed: false,
      list: [],
      loading: true,
      success: false,
    },
  };

  const scenarios = [
    {
      campaign: {
        approvedByEmail: null,
        campaignId: 'campaign-id',
        endDate: today,
        endTimestamp: null,
        incentives: [],
        isShortTerm: true,
        liveTimestamp: today,
        schedule: [
          {
            dayOfWeek: 'FRIDAY',
            endTime: '10:30:00',
            startTime: '08:00:00',
          },
        ],
        startDate: today,
        state: CampaignState.Live,
        suppressionDates,
      },
      description: 'short term single shift live campaign',
    },
    {
      campaign: {
        approvedByEmail: null,
        campaignId: 'campaign-id',
        endDate: tomorrow,
        endTimestamp: null,
        incentives: [],
        isShortTerm: true,
        liveTimestamp: yesterday,
        schedule: [
          {
            dayOfWeek: 'FRIDAY',
            endTime: '10:30:00',
            startTime: '08:00:00',
          },
        ],
        startDate: today,
        state: CampaignState.Live,
        suppressionDates,
      },
      description: 'short term live campaign',
    },
    {
      campaign: {
        approvedByEmail: null,
        campaignId: 'campaign-id',
        changedByUser: 'jest@example.com',
        endDate: today,
        endTimestamp: today,
        incentives: [],
        isShortTerm: true,
        liveTimestamp: yesterday,
        schedule: [
          {
            dayOfWeek: 'FRIDAY',
            endTime: '10:30:00',
            startTime: '08:00:00',
          },
        ],
        startDate: today,
        state: CampaignState.Ended,
        suppressionDates,
      },
      description: 'short term ended campaign',
    },
    {
      campaign: {
        approvedByEmail: 'isr@opentable.com',
        campaignId: 'campaign-id',
        changedByUser: 'jest@example.com',
        endDate: today,
        endTimestamp: today,
        incentives: [],
        isShortTerm: false,
        liveTimestamp: yesterday,
        schedule: [
          {
            dayOfWeek: 'FRIDAY',
            endTime: '10:30:00',
            startTime: '08:00:00',
          },
        ],
        startDate: today,
        state: CampaignState.Ended,
        suppressionDates,
      },
      description: 'campaign with @opentable email address',
    },
    {
      campaign: {
        approvedByEmail: 'isr@example.com',
        campaignId: 'campaign-id',
        changedByUser: 'jest@example.com',
        endDate: dayAfterTomorrow,
        endTimestamp: dayAfterTomorrow,
        incentives: [],
        isShortTerm: false,
        liveTimestamp: yesterday,
        pauseUntil: tomorrow,
        schedule: [
          {
            dayOfWeek: 'FRIDAY',
            endTime: '10:30:00',
            startTime: '08:00:00',
          },
        ],
        startDate: yesterday,
        state: CampaignState.Paused,
        suppressionDates,
      },
      description: 'paused campaign',
    },
    {
      campaign: {
        approvedByEmail: 'jest@example.com',
        campaignId: 'campaign-id',
        endDate: tomorrow,
        endTimestamp: null,
        isShortTerm: false,
        liveTimestamp: yesterday,
        schedule: [],
        startDate: today,
        state: CampaignState.Live,
        suppressionDates,
        targets: ['planner', 'local_diner'],
      },
      description: 'live campaign w/ targets',
    },
    {
      campaign: {
        approvedByEmail: 'pi-engineering@opentable.com',
        campaignId: 'd28551b9-f06a-464b-80ac-3b8bacc5d256',
        ccEmails: [],
        changedByUser: 'pi-engineering@opentable.com',
        changedTimestamp: '2018-04-17T18:24:07.035Z',
        createdByEmail: 'pi-engineering@opentable.com',
        createdChannel: 'ISR Tool',
        createdTimestamp: '2018-04-17T18:23:58.741Z',
        currentVersion: '2',
        draftTimestamp: '2018-04-17T18:23:58.741Z',
        incentives: [],
        isShortTerm: false,
        liveTimestamp: '2018-04-17T18:24:07.035Z',
        pricingTier: { tier: 'High', price: 2.75, currencyCode: 'USD' },
        restaurantContactEmail: 'jcarlson@opentable.com',
        restaurantContactName: 'James Carlson',
        rid: 268852,
        schedule: [
          { startTime: '10:15:00', endTime: '16:00:00', dayOfWeek: 'MONDAY' },
          { startTime: '04:00:00', endTime: '10:00:00', dayOfWeek: 'SUNDAY' },
        ],
        startDate: '2018-04-17',
        state: CampaignState.Live,
        suppressionDates: {
          custom: [],
          default: [
            'mothers_day_us',
            'thanksgiving_day_us',
            'christmas_eve',
            'christmas_day',
            'new_years_eve',
            'new_years_day',
            'valentines_day',
          ],
        },
        targets: [],
        type: CampaignTypes.CustomPromotions,
      },
      description: 'live Custom Promotions campaign without Budget',
    },
    {
      campaign: {
        approvedByEmail: 'pi-engineering@opentable.com',
        campaignId: 'd28551b9-f06a-464b-80ac-3b8bacc5d256',
        ccEmails: [],
        changedByUser: 'pi-engineering@opentable.com',
        changedTimestamp: '2018-04-17T18:24:07.035Z',
        createdByEmail: 'pi-engineering@opentable.com',
        createdChannel: 'ISR Tool',
        createdTimestamp: '2018-04-17T18:23:58.741Z',
        currentVersion: '2',
        draftTimestamp: '2018-04-17T18:23:58.741Z',
        incentives: [],
        isShortTerm: false,
        liveTimestamp: '2018-04-17T18:24:07.035Z',
        monthlyBudget: 200,
        pricingTier: { tier: 'High', price: 2.75, currencyCode: 'USD' },
        restaurantContactEmail: 'jcarlson@opentable.com',
        restaurantContactName: 'James Carlson',
        rid: 268852,
        schedule: [
          { startTime: '10:15:00', endTime: '16:00:00', dayOfWeek: 'MONDAY' },
          { startTime: '04:00:00', endTime: '10:00:00', dayOfWeek: 'SUNDAY' },
        ],
        startDate: '2018-04-17',
        state: CampaignState.Live,
        suppressionDates: {
          custom: [],
          default: [
            'mothers_day_us',
            'thanksgiving_day_us',
            'christmas_eve',
            'christmas_day',
            'new_years_eve',
            'new_years_day',
            'valentines_day',
          ],
        },
        targets: [],
        type: CampaignTypes.CustomPromotions,
      },
      description: 'live Custom Promotions campaign with Budget',
    },
    {
      campaign: {
        approvedByEmail: 'pi-engineering@opentable.com',
        campaignId: 'd28551b9-f06a-464b-80ac-3b8bacc5d256',
        ccEmails: [],
        changedByUser: 'pi-engineering@opentable.com',
        changedTimestamp: '2018-04-17T18:24:07.035Z',
        createdByEmail: 'pi-engineering@opentable.com',
        createdChannel: 'ISR Tool',
        createdTimestamp: '2018-04-17T18:23:58.741Z',
        currentVersion: '2',
        draftTimestamp: '2018-04-17T18:23:58.741Z',
        incentives: [],
        isShortTerm: false,
        liveTimestamp: '2018-04-17T18:24:07.035Z',
        monthlyBudget: 200.01,
        pricingTier: { tier: 'High', price: 2.75, currencyCode: 'USD' },
        restaurantContactEmail: 'jcarlson@opentable.com',
        restaurantContactName: 'James Carlson',
        rid: 268852,
        schedule: [
          { startTime: '10:15:00', endTime: '16:00:00', dayOfWeek: 'MONDAY' },
          { startTime: '04:00:00', endTime: '10:00:00', dayOfWeek: 'SUNDAY' },
        ],
        startDate: '2018-04-17',
        state: CampaignState.Live,
        suppressionDates: {
          custom: [],
          default: [
            'mothers_day_us',
            'thanksgiving_day_us',
            'christmas_eve',
            'christmas_day',
            'new_years_eve',
            'new_years_day',
            'valentines_day',
          ],
        },
        targets: [],
        type: CampaignTypes.PromotedResults,
      },
      description: 'live Promoted Results campaign with Budget',
    },
    {
      campaign: {
        approvedByEmail: 'pi-engineering@opentable.com',
        campaignId: 'd28551b9-f06a-464b-80ac-3b8bacc5d256',
        ccEmails: [],
        changedByUser: 'pi-engineering@opentable.com',
        changedTimestamp: '2018-04-17T18:24:07.035Z',
        createdByEmail: 'pi-engineering@opentable.com',
        createdChannel: 'ISR Tool',
        createdTimestamp: '2018-04-17T18:23:58.741Z',
        currentVersion: '2',
        draftTimestamp: '2018-04-17T18:23:58.741Z',
        incentives: [],
        isShortTerm: false,
        liveTimestamp: '2018-04-17T18:24:07.035Z',
        pricingTier: { tier: 'High', price: 2.75, currencyCode: 'USD' },
        restaurantContactEmail: 'jcarlson@opentable.com',
        restaurantContactName: 'James Carlson',
        rid: 268852,
        schedule: [
          { startTime: '10:15:00', endTime: '16:00:00', dayOfWeek: 'MONDAY' },
          { startTime: '04:00:00', endTime: '10:00:00', dayOfWeek: 'SUNDAY' },
        ],
        startDate: '2018-04-17',
        state: CampaignState.Live,
        suppressionDates: {
          custom: [],
          default: [
            'mothers_day_us',
            'thanksgiving_day_us',
            'christmas_eve',
            'christmas_day',
            'new_years_eve',
            'new_years_day',
            'valentines_day',
          ],
        },
        targets: [],
        type: CampaignTypes.PromotedResults,
      },
      description: 'live Promoted Results campaign without Budget',
    },
  ];

  scenarios.map(({ description, campaign }) => {
    test(`${description} to match snapshot`, () => {
      const store = configureMockStore([])(state);
      const component = create(
        <Provider store={store}>
          <IntlProvider locale="en-US" messages={keys}>
            <tr>
              <PromotedResultsDetails campaign={campaign as CampaignType} />
            </tr>
          </IntlProvider>
        </Provider>,
      );
      const tree = component.toJSON();
      expect(tree).toMatchSnapshot();
    });
  });

  test('clicking Edit Blocked Days will fire openModal', () => {
    const store = configureMockStore([])(state);
    const campaign = {
      approvedByEmail: 'isr@opentable.com',
      campaignId: 'campaign-id',
      changedByUser: 'jest@example.com',
      endDate: today,
      endTimestamp: today,
      incentives: [],
      isShortTerm: false,
      liveTimestamp: yesterday,
      schedule: [
        {
          dayOfWeek: 'FRIDAY',
          endTime: '10:30:00',
          startTime: '08:00:00',
        },
      ],
      startDate: today,
      state: CampaignState.Live,
      suppressionDates,
    };
    const wrapper = mount(
      <Provider store={store}>
        <IntlProvider locale="en-US" messages={keys}>
          <table>
            <tbody>
              <tr>
                <PromotedResultsDetails campaign={campaign as CampaignType} />
              </tr>
            </tbody>
          </table>
        </IntlProvider>
      </Provider>,
    );
    const editButton = wrapper.find('.edit-blocked-days-li');
    editButton.simulate('click');
    expect(store.getActions()[0].type).toEqual('CAMPAIGNS/OPEN_MODAL');
  });
});
