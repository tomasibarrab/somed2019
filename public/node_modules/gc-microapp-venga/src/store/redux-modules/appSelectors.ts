import { CurrentContext } from 'gca-react-components/src/redux-modules/currentContext';
import get from 'lodash/get';
import { createSelector } from 'reselect';

import { State } from '../types';
import { selectors as productSelectors } from './products';


// ======================== App Selectors ============================

const currentContextSelector = (state: State) => state.currentContext;

const restaurantCountryCode = createSelector<State, CurrentContext, string | undefined>(currentContextSelector,
  (currentContext) =>
    get(currentContext.restaurant, ['address', 'countryCode']),
);

const isVengaCompliant = (state: State) => (
  restaurantCountryCode(state) === 'US'
  && state.featureToggles.features.transientVengaOnboardingRid
  && productSelectors.productsValidPrices(state)
);

const isAppLoading = (state: State) => (
  currentContextSelector(state).isFetching
  || productSelectors.productsLoading(state)
);

const isAppError = (state: State) => (
  currentContextSelector(state).fetchFailed
  || productSelectors.productsErrors(state)
);

export const selectors = {
  isAppError,
  isAppLoading,
  isVengaCompliant,
  restaurantCountryCode,
};
