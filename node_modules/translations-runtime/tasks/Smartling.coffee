require "coffee-script/register"
translationToolsInjector = require "../src/injector"
fs = require "vinyl-fs"
path = require "path"

module.exports = (grunt) ->

  translationToolsInjector().inject (TranslationsClient, TranslationsDownloadStream) ->

    download = (grunt) ->
      done = this.async()
      rootPath = this.data.root
      dest = this.data.dest or path.join(rootPath, "generated/")

      if rootPath
        TranslationsDownloadStream
          .download(rootPath, this.data.manifest, this.data.bundles, this.data.supportingFiles)
          .pipe(fs.dest(dest))
          .on('end', done)
          .on('error', (err) -> grunt.util.error(err))
      else
        grunt.util.error("Root path is not specified")

    upload = (grunt) ->
      rootPath = this.data.root
      done = this.async()

      if rootPath
        TranslationsClient
          .upload(rootPath, this.data.manifest, this.data.bundles)
          .then(done)
          .catch (error) ->
            grunt.util.error("Error uploading", error)
      else
        grunt.util.error("Root path is not specified")


    grunt.registerMultiTask('smartling_download', 'downloads from smartling', download)
    grunt.registerMultiTask('smartling_upload', 'uploads to smartling', upload)
